# database/sql

# 一. 介绍

> Go语言中的 `database/sql` 包提供了保证SQL或类SQL数据库的泛用接口，并不提供具体的数据库 驱动，使用 `database/sql` 包时必须注入一个数据库驱动。

https://github.com/go-sql-driver/mysql

# 	二. 安装

```shell
go get -u github.com/go-sql-driver/mysql
```

```go
// 使用Open方法打开一个dirverName指定的数据库，
// dataSourceName指定数据源，username， password，host，port，databasename等连接必要信息
func Open(driverName, dataSourceName string) (*DB, error)
```

# 三. 快速开始

## 3.1 连接测试

```go
import (
    "database/sql"
    "time"
    _ "github.com/go-sql-driver/mysql"
)

func TestConnect2Mysql(t testing.T) {
    // ...
    database := "mysql"
    dns := "root:root@tcp(localhost:3306)/demo?charset=utf8&parseTime=True&loc=Local"
    db, err := sql.Open(database, dns)
    if err != nil {
    	panic(err) 
    }
    // See "Important settings" section.
    db.SetConnMaxLifetime(time.Minute * 3)
    db.SetMaxOpenConns(10)
    db.SetMaxIdleConns(10)
    if err := db.Ping(); err != nil {
        panic(err)
    }
    fmt.Println("connect 2 database")
}
```

**SetMaxOpenConns**：

​		`SetMaxOpenConns` 设置与数据库建立连接的最大数目。 如果n大于0且小于最大闲置连接数，会将最大 闲置连接数减小到匹配最大开启连接数的限制。 如果n<=0，不会限制最大开启连接数，默认为0(无限 制)

```go
func (db *DB) SetMaxOpenConns(n int)
```

**SetMaxIdleConns**：

`SetMaxIdleConns` 设置连接池中的最大闲置连接数。 如果n大于最大开启连接数，则新的最大闲置连 接数会减小到匹配最大开启连接数的限制。 如果 n<=0，不会保留闲置连接

```go
 func (db *DB) SetMaxIdleConns(n int)
```

## 3.2 封装连接函数

```go
var DB *sql.DB
// initializeDatabase 初始化
func initializeDatabase() error {
    dsn := "root:123456@tcp(localhost:4000)/gin_demo?
    charset=utf8mb4&parseTime=True&loc=Local"
    db, err := sql.Open("mysql", dsn)
    if err != nil {
        return err }
    DB = db
    if err = db.Ping(); err != nil {
        return err 
    }
    return nil 
}

func main() {
    // ...
    if err := initializeDatabase(); err != nil {
        panic(err)
    }
}
```













